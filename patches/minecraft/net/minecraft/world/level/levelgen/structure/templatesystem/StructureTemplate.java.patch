--- a/net/minecraft/world/level/levelgen/structure/templatesystem/StructureTemplate.java
+++ b/net/minecraft/world/level/levelgen/structure/templatesystem/StructureTemplate.java
@@ -64,11 +_,16 @@
    public static final String f_163797_ = "blockPos";
    public static final String f_163798_ = "nbt";
    public static final String f_163799_ = "size";
-   private final List<StructureTemplate.Palette> f_74482_ = Lists.newArrayList();
-   private final List<StructureTemplate.StructureEntityInfo> f_74483_ = Lists.newArrayList();
+   public final List<StructureTemplate.Palette> f_74482_ = Lists.newArrayList();
+   public final List<StructureTemplate.StructureEntityInfo> f_74483_ = Lists.newArrayList();
    private Vec3i f_74484_ = Vec3i.f_123288_;
    private String f_74485_ = "?";
 
+   // CraftBukkit start - data containers
+   private static final org.bukkit.craftbukkit.v1_20_R1.persistence.CraftPersistentDataTypeRegistry DATA_TYPE_REGISTRY = new org.bukkit.craftbukkit.v1_20_R1.persistence.CraftPersistentDataTypeRegistry();
+   public org.bukkit.craftbukkit.v1_20_R1.persistence.CraftPersistentDataContainer persistentDataContainer = new org.bukkit.craftbukkit.v1_20_R1.persistence.CraftPersistentDataContainer(DATA_TYPE_REGISTRY);
+   // CraftBukkit end
+
    public Vec3i m_163801_() {
       return this.f_74484_;
    }
@@ -201,6 +_,10 @@
       return m_74593_(p_74565_, p_74564_.m_74401_(), p_74564_.m_74404_(), p_74564_.m_74407_());
    }
 
+   public static Vec3 transformedVec3d(StructurePlaceSettings placementIn, Vec3 pos) {
+      return m_74578_(pos, placementIn.m_74401_(), placementIn.m_74404_(), placementIn.m_74407_());
+   }
+
    public boolean m_230328_(ServerLevelAccessor p_230329_, BlockPos p_230330_, BlockPos p_230331_, StructurePlaceSettings p_230332_, RandomSource p_230333_, int p_230334_) {
       if (this.f_74482_.isEmpty()) {
          return false;
@@ -218,7 +_,7 @@
             int i1 = Integer.MIN_VALUE;
             int j1 = Integer.MIN_VALUE;
 
-            for(StructureTemplate.StructureBlockInfo structuretemplate$structureblockinfo : m_74517_(p_230329_, p_230330_, p_230331_, p_230332_, list)) {
+            for(StructureTemplate.StructureBlockInfo structuretemplate$structureblockinfo : processBlockInfos(p_230329_, p_230330_, p_230331_, p_230332_, list, this)) {
                BlockPos blockpos = structuretemplate$structureblockinfo.f_74675_;
                if (boundingbox == null || boundingbox.m_71051_(blockpos)) {
                   FluidState fluidstate = p_230332_.m_74413_() ? p_230329_.m_6425_(blockpos) : null;
@@ -359,7 +_,15 @@
       });
    }
 
+   /**
+    * @deprecated Forge: Use {@link #processBlockInfos(ServerLevelAccessor, BlockPos, BlockPos, StructurePlaceSettings, List, StructureTemplate)} instead.
+    */
+   @Deprecated
    public static List<StructureTemplate.StructureBlockInfo> m_74517_(ServerLevelAccessor p_278297_, BlockPos p_74519_, BlockPos p_74520_, StructurePlaceSettings p_74521_, List<StructureTemplate.StructureBlockInfo> p_74522_) {
+      return processBlockInfos(p_278297_, p_74519_, p_74520_, p_74521_, p_74522_, null);
+   }
+
+   public static List<StructureTemplate.StructureBlockInfo> processBlockInfos(ServerLevelAccessor p_278297_, BlockPos p_74519_, BlockPos p_74520_, StructurePlaceSettings p_74521_, List<StructureTemplate.StructureBlockInfo> p_74522_, @Nullable StructureTemplate template) {
       List<StructureTemplate.StructureBlockInfo> list = new ArrayList<>();
       List<StructureTemplate.StructureBlockInfo> list1 = new ArrayList<>();
 
@@ -367,7 +_,7 @@
          BlockPos blockpos = m_74563_(p_74521_, structuretemplate$structureblockinfo.f_74675_).m_121955_(p_74519_);
          StructureTemplate.StructureBlockInfo structuretemplate$structureblockinfo1 = new StructureTemplate.StructureBlockInfo(blockpos, structuretemplate$structureblockinfo.f_74676_, structuretemplate$structureblockinfo.f_74677_ != null ? structuretemplate$structureblockinfo.f_74677_.m_6426_() : null);
 
-         for(Iterator<StructureProcessor> iterator = p_74521_.m_74411_().iterator(); structuretemplate$structureblockinfo1 != null && iterator.hasNext(); structuretemplate$structureblockinfo1 = iterator.next().m_7382_(p_278297_, p_74519_, p_74520_, structuretemplate$structureblockinfo, structuretemplate$structureblockinfo1, p_74521_)) {
+         for(Iterator<StructureProcessor> iterator = p_74521_.m_74411_().iterator(); structuretemplate$structureblockinfo1 != null && iterator.hasNext(); structuretemplate$structureblockinfo1 = iterator.next().process(p_278297_, p_74519_, p_74520_, structuretemplate$structureblockinfo, structuretemplate$structureblockinfo1, p_74521_, template)) {
          }
 
          if (structuretemplate$structureblockinfo1 != null) {
@@ -383,6 +_,23 @@
       return list1;
    }
 
+   public static List<StructureTemplate.StructureEntityInfo> processEntityInfos(@Nullable StructureTemplate template, LevelAccessor p_215387_0_, BlockPos p_215387_1_, StructurePlaceSettings p_215387_2_, List<StructureTemplate.StructureEntityInfo> p_215387_3_) {
+      List<StructureTemplate.StructureEntityInfo> list = Lists.newArrayList();
+      for(StructureTemplate.StructureEntityInfo entityInfo : p_215387_3_) {
+         Vec3 pos = transformedVec3d(p_215387_2_, entityInfo.f_74683_).m_82549_(Vec3.m_82528_(p_215387_1_));
+         BlockPos blockpos = m_74563_(p_215387_2_, entityInfo.f_74684_).m_121955_(p_215387_1_);
+         StructureTemplate.StructureEntityInfo info = new StructureTemplate.StructureEntityInfo(pos, blockpos, entityInfo.f_74685_);
+         for (StructureProcessor proc : p_215387_2_.m_74411_()) {
+            info = proc.processEntity(p_215387_0_, p_215387_1_, entityInfo, info, p_215387_2_, template);
+            if (info == null)
+               break;
+         }
+         if (info != null)
+            list.add(info);
+      }
+      return list;
+   }
+
    private void m_74523_(ServerLevelAccessor p_74524_, BlockPos p_74525_, Mirror p_74526_, Rotation p_74527_, BlockPos p_74528_, @Nullable BoundingBox p_74529_, boolean p_74530_) {
       for(StructureTemplate.StructureEntityInfo structuretemplate$structureentityinfo : this.f_74483_) {
          BlockPos blockpos = m_74593_(structuretemplate$structureentityinfo.f_74684_, p_74526_, p_74527_, p_74528_).m_121955_(p_74525_);
@@ -412,11 +_,13 @@
    }
 
    private static Optional<Entity> m_74543_(ServerLevelAccessor p_74544_, CompoundTag p_74545_) {
-      try {
+      // CraftBukkit start
+      // try {
          return EntityType.m_20642_(p_74545_, p_74544_.m_6018_());
-      } catch (Exception exception) {
-         return Optional.empty();
-      }
+      // } catch (Exception exception) {
+      //    return Optional.empty();
+      // }
+      // CraftBukkit end
    }
 
    public Vec3i m_163808_(Rotation p_163809_) {
@@ -607,6 +_,11 @@
 
       p_74619_.m_128365_("entities", listtag);
       p_74619_.m_128365_("size", this.m_74625_(this.f_74484_.m_123341_(), this.f_74484_.m_123342_(), this.f_74484_.m_123343_()));
+      // CraftBukkit start - PDC
+      if (!this.persistentDataContainer.isEmpty()) {
+         p_74619_.m_128365_("BukkitValues", this.persistentDataContainer.toTagCompound());
+      }
+      // CraftBukkit end
       return NbtUtils.m_264171_(p_74619_);
    }
 
@@ -640,6 +_,12 @@
          }
       }
 
+      // CraftBukkit start - PDC
+      net.minecraft.nbt.Tag base = p_248574_.m_128423_("BukkitValues");
+      if (base instanceof CompoundTag) {
+         this.persistentDataContainer.putAll((CompoundTag) base);
+      }
+      // CraftBukkit end
    }
 
    private void m_247272_(HolderGetter<Block> p_256546_, ListTag p_251056_, ListTag p_251493_) {
